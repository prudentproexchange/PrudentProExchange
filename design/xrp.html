<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>XRP Payment • PrudentProExchange</title>
  <link rel="stylesheet" href="css/style.css"/>
  <link rel="stylesheet" href="css/xrp.css"/>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="xrp-page">
  <!-- NAV -->
  <header class="site-header">
    <a href="dashboard.html" class="logo-link">
      <img src="assets/images/logo.svg" alt="Logo" class="logo"/>
    </a>
    <button id="theme-toggle" aria-label="Toggle theme">
      <i class="fas fa-moon"></i>
    </button>
    <nav class="nav-drawer">
      <a href="dashboard.html">Dashboard</a>
      <a href="invest.html">Invest</a>
      <a href="withdraw.html">Withdraw</a>
      <a href="transactions.html">Transactions</a>
      <a href="referrals.html">Referrals</a>
      <div class="account-menu">
        <button id="account-toggle">Account ▾</button>
        <ul class="submenu">
          <li><a href="profile-settings.html">Profile Settings</a></li>
          <li><a href="#" id="logout-btn">Logout</a></li>
        </ul>
      </div>
    </nav>
  </header>

  <!-- PAYMENT CARD -->
  <main class="container">
    <section class="payment-card">
      <h1>XRP Payment</h1>
      <div class="details">
        <p><strong>Plan:</strong> <span id="planName"></span></p>
        <p><strong>Return:</strong> <span id="weeklyReturn"></span></p>
        <p><strong>Range:</strong> <span id="investmentRange"></span></p>
        <p><strong>Amount ($):</strong> <span id="investmentAmount">0.00</span></p>
      </div>

      <div class="wallet-section">
        <label>Wallet Address:</label>
        <div class="wallet-copy">
          <input type="text" id="walletAddress" readonly/>
          <button id="copyBtn" aria-label="Copy wallet address">
            <i class="fas fa-copy"></i>
          </button>
        </div>
      </div>

      <form id="paymentForm" enctype="multipart/form-data">
        <label for="proofUpload">Proof of Payment (PNG/JPG, ≤5MB):</label>
        <input type="file" id="proofUpload"
               accept="image/png,image/jpeg,image/gif" required/>
        <button type="submit" class="btn">Paid</button>
      </form>
    </section>
  </main>

  <footer class="site-footer">
    <p>© 2025 PrudentProExchange</p>
  </footer>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // 1) Theme toggle
    document.getElementById('theme-toggle').addEventListener('click', () => {
      document.body.classList.toggle('light-theme');
      const icon = event.currentTarget.firstElementChild;
      icon.classList.toggle('fa-moon');
      icon.classList.toggle('fa-sun');
    });

    // 2) Account menu
    document.getElementById('account-toggle')
      .addEventListener('click', e => {
        e.currentTarget.nextElementSibling.classList.toggle('open');
      });

    // 3) Supabase init
    const SUPABASE_URL = 'https://YOUR-PROJECT.supabase.co';
    const SUPABASE_ANON = 'YOUR-ANON-KEY';
    const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON);

    // 4) Load user + profile
    async function init() {
      const { data: { user }, error: authErr } = await supabase.auth.getUser();
      if (authErr || !user) return window.location = 'login.html';

      // fill plan from URL
      const params = new URLSearchParams(window.location.search);
      const planKey = params.get('plan');
      const amount = parseFloat(params.get('amount')||0).toFixed(2);
      const plans = {
        'xrp-standard': {
          name:'XRP Standard',
          weekly:'5% weekly',
          range:'20–100,000'
        }
      };
      if (!plans[planKey]) return alert('Invalid plan'), location='invest.html';

      const p = plans[planKey];
      document.getElementById('planName').textContent = p.name;
      document.getElementById('weeklyReturn').textContent = p.weekly;
      document.getElementById('investmentRange').textContent = p.range;
      document.getElementById('investmentAmount').textContent = amount;

      // fetch wallet
      let { data: wallet, error: wErr } = await supabase
        .from('wallets')
        .select('address')
        .eq('currency','XRP')
        .single();
      if (wErr || !wallet) {
        console.error(wErr);
        return alert('Error loading wallet. Contact support.');
      }
      document.getElementById('walletAddress').value = wallet.address;
    }
    init();

    // 5) Copy to clipboard
    document.getElementById('copyBtn').addEventListener('click', async () => {
      try {
        const text = document.getElementById('walletAddress').value;
        await navigator.clipboard.writeText(text);
        const btn = event.currentTarget;
        btn.innerHTML = '<i class="fas fa-check"></i>';
        setTimeout(() => btn.innerHTML = '<i class="fas fa-copy"></i>', 1500);
      } catch (e) {
        alert('Copy failed: '+ e.message);
      }
    });

    // 6) Handle payment proof upload
    document.getElementById('paymentForm').addEventListener('submit', async e => {
      e.preventDefault();
      const fileInput = document.getElementById('proofUpload');
      const file = fileInput.files[0];
      if (!file) return alert('Please select a file.');
      if (file.size > 5*1024*1024) return alert('Max 5MB.');
      // re-get user
      const { data:{ user } } = await supabase.auth.getUser();

      // upload
      const fileName = `xrp/${user.id}/${Date.now()}_${file.name}`;
      let { error: upErr } = await supabase
        .storage.from('payment-proofs')
        .upload(fileName, file, { upsert: false });
      if (upErr) {
        console.error(upErr);
        return alert('Upload failed.');
      }

      // record in table
      const params = new URLSearchParams(window.location.search);
      const amt = parseFloat(params.get('amount')||0);
      const planKey = params.get('plan');
      let { error: insErr } = await supabase
        .from('transactions')
        .insert({
          user_id: user.id,
          amount: amt,
          currency: 'XRP',
          proof_file: fileName,
          status: 'pending',
          investment_plan: planKey
        });
      if (insErr) {
        console.error(insErr);
        return alert('Submission failed.');
      }

      alert('Proof submitted – awaiting approval!');
      location = 'dashboard.html';
    });

    // 7) Logout
    document.getElementById('logout-btn').addEventListener('click', async () => {
      await supabase.auth.signOut();
      location = 'login.html';
    });
  });
  </script>
</body>
</html>
