<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>XRP Payment â€¢ PrudentProExchange</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; max-width: 500px; margin: auto; }
    .wallet { margin: 1rem 0; }
    input, button { display: block; width: 100%; margin: 0.5rem 0; padding: 0.5rem; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
  <h1>XRP Payment</h1>
  <div class="wallet">
    <label>Wallet Address:</label>
    <div style="display:flex;">
      <input id="walletAddress" readonly/>
      <button id="copyBtn" style="width:auto; margin-left:0.5rem;">Copy</button>
    </div>
  </div>

  <form id="paymentForm" enctype="multipart/form-data">
    <label for="proofUpload">Upload Proof of Payment (PNG/JPG/GIF, max 5MB):</label>
    <input type="file" id="proofUpload" accept="image/png,image/jpeg,image/gif" required/>
    <button type="submit">Paid</button>
  </form>

  <script>
    // Initialize Supabase
    const supabaseUrl = 'https://iwkdznjqfbsfkscnbrkc.supabase.co';
    const supabaseKey = 'YOUR_PUBLIC_ANON_KEY';
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    // Load wallet address
    async function loadWallet() {
      const { data: { user } } = await supabase.auth.getUser();
      const { data, error } = await supabase
        .from('wallets')
        .select('address')
        .eq('currency', 'XRP')
        .single();
      if (error || !data) return alert('Error loading XRP wallet address: ' + (error?.message || 'none'));
      document.getElementById('walletAddress').value = data.address;
    }

    // Copy to clipboard
    document.getElementById('copyBtn').addEventListener('click', async () => {
      const addr = document.getElementById('walletAddress').value;
      try {
        await navigator.clipboard.writeText(addr);
        alert('ðŸ“‹ Copied!');
      } catch (e) {
        alert('Copy failed: ' + e.message);
      }
    });

    // Handle proof upload
    document.getElementById('paymentForm').addEventListener('submit', async e => {
      e.preventDefault();
      const file = document.getElementById('proofUpload').files[0];
      if (!file) return alert('Select a file!');
      if (file.size > 5 * 1024 * 1024) return alert('Max 5MB.');

      const { data: { user } } = await supabase.auth.getUser();
      const fileName = `xrp-proof-${user.id}-${Date.now()}.${file.name.split('.').pop()}`;
      const { error: upErr } = await supabase.storage
        .from('payment-proofs')
        .upload(fileName, file);
      if (upErr) return alert('Upload failed: ' + upErr.message);

      // Record the transaction
      const params = new URLSearchParams(window.location.search);
      const amount = parseFloat(params.get('amount'));
      const plan = params.get('plan');
      const { error: insErr } = await supabase
        .from('transactions')
        .insert({ user_id: user.id, amount, currency: 'XRP', proof_file: fileName, status: 'pending', investment_plan: plan });
      if (insErr) return alert('DB insert failed: ' + insErr.message);

      alert('âœ… Proof submitted! Awaiting review.');
      window.location.href = 'dashboard.html';
    });

    // Kick off
    loadWallet();
  </script>
</body>
</html>
