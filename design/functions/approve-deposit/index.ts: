// supabase/functions/approveProof/index.ts
import { serve } from "https://deno.land/x/supabase_functions@0.1.2/mod.ts"
import { createClient } from "https://esm.sh/@supabase/supabase-js@^2"

serve(async (req) => {
  const { path, action } = await req.json()
  const [userId, filename] = path.split("/")
  const depositId = filename.split("_")[0]

  const supabase = createClient(
    Deno.env.get("https://iwkdznjqfbsfkscnbrkc.supabase.co")!,
    Deno.env.get("eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml3a2R6bmpxZmJzZmtzY25icmtjIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1MDYyOTY4OCwiZXhwIjoyMDY2MjA1Njg4fQ.HPkLtB4-tf6R_4HtyhJVJ1iixIMAY_FVUDqjhHKymRw")!
  )

  // remove or keep file
  if (action === "delete") {
    await supabase.storage.from("payment-proofs").remove([path])
  }
  // update deposit
  await supabase.from("deposits")
    .update({ status: action === "approve" ? "approved" : "rejected" })
    .eq("id", depositId)

  return new Response(JSON.stringify({ success: true }))
})
