<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>2FA Settings â€¢ PrudentProExchange</title>
  <link rel="stylesheet" href="css/style.css"/>
  <link rel="stylesheet" href="css/2fa.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body class="twofa-page">
  <div class="overlay">
    <!-- ... your header/nav/profile markup ... -->

    <main class="twofa-page container" data-aos="fade-up">
      <h2>Two-Factor Authentication Settings</h2>
      <p id="status" class="status-message"></p>

      <section id="enable-section" style="display:none;">
        <img id="qr" style="max-width:200px; display:block; margin:1rem auto;"/>
        <p>Secret: <code id="secret"></code> <button id="copy-secret"><i class="fas fa-copy"></i></button></p>
        <input type="text" id="token-enable" maxlength="6" placeholder="Enter 6-digit code"/>
        <button id="btn-enable">Verify & Enable 2FA</button>
      </section>

      <section id="disable-section" style="display:none;">
        <input type="text" id="token-disable" maxlength="6" placeholder="Enter 6-digit code"/>
        <button id="btn-disable">Verify & Disable 2FA</button>
      </section>

      <p id="error" style="color:#f66; display:none;"></p>
    </main>

    <!-- ... your footer ... -->
  </div>

  <script>
    AOS.init({ duration:800, once:true });
    const { createClient } = supabase;
    const supabase = createClient(
      'https://iwkdznjqfbsfkscnbrkc.supabase.co',
      'YOUR_ANON_KEY'
    );

    async function init() {
      const { data: { user }, error: authErr } = await supabase.auth.getUser();
      if (authErr || !user) return location.replace('login.html');

      // Check current enrollment
      const { data: mfaState, error: stateErr } = await supabase.auth.mfa.getEnrollment();
      if (stateErr) return showError(stateErr.message);

      document.getElementById('status').textContent = 
        mfaState.enabled 
          ? '2FA is currently ENABLED.' 
          : '2FA is currently DISABLED.';

      if (mfaState.enabled) {
        document.getElementById('disable-section').style.display = 'block';
      } else {
        document.getElementById('enable-section').style.display = 'block';
        await generateTOTP();
      }

      document.getElementById('btn-enable').onclick  = enableTOTP;
      document.getElementById('btn-disable').onclick = disableTOTP;
      document.getElementById('copy-secret').onclick = () => {
        navigator.clipboard.writeText(document.getElementById('secret').textContent);
      };
    }

    async function generateTOTP() {
      const { data, error } = await supabase.auth.mfa.generateTOTP();
      if (error) return showError('Error generating 2FA secret: ' + error.message);

      document.getElementById('qr').src     = data.totp_url;
      document.getElementById('secret').textContent = data.secret;
    }

    async function enableTOTP() {
      const token = document.getElementById('token-enable').value.trim();
      if (!/^\d{6}$/.test(token)) return showError('Enter a valid 6-digit code.');

      const { error: verifyErr } = await supabase.auth.mfa.verifyTOTP({ token });
      if (verifyErr) return showError('Invalid code: ' + verifyErr.message);

      const { error: toggleErr } = await supabase.auth.mfa.toggleTOTPEnrollment({ enable: true });
      if (toggleErr) return showError('Failed to enable 2FA: ' + toggleErr.message);

      alert('2FA enabled!');
      location.reload();
    }

    async function disableTOTP() {
      const token = document.getElementById('token-disable').value.trim();
      if (!/^\d{6}$/.test(token)) return showError('Enter a valid 6-digit code.');

      const { data, error: verifyErr } = await supabase.auth.mfa.verifyTOTP({ token });
      if (verifyErr) return showError('Invalid code: ' + verifyErr.message);

      const { error: toggleErr } = await supabase.auth.mfa.toggleTOTPEnrollment({ enable: false });
      if (toggleErr) return showError('Failed to disable 2FA: ' + toggleErr.message);

      alert('2FA disabled!');
      location.reload();
    }

    function showError(msg) {
      const e = document.getElementById('error');
      e.textContent = msg;
      e.style.display = 'block';
      setTimeout(() => e.style.display = 'none', 5000);
    }

    init();
  </script>
</body>
</html>
